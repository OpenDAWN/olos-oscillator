<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-dropdown/paper-dropdown.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../core-menu/core-menu.html">
<link rel="import" href="../core-tooltip/core-tooltip.html">

<!-- <link rel="import" href="../font-roboto/roboto.html"> -->

<!--
olos-oscillator is an oscillator
##### Example


@element olos-oscillator
@blurb 
@status alpha
@homepage http://olosmusic.github.io/olos-oscillator
-->
<polymer-element name="olos-oscillator" attributes="frequencyParam detuneParam output width height color src play rootfolder">
  <template>
    <link rel="stylesheet" href="olos-oscillator.css"></link>

    <div class="olos-container">

      <div>
        <paper-dropdown-menu id="oscType">
            <label> <core-icon src="./icons/sine_.svg" id="oscimage" style="width:25px; height:25px;"></core-icon> </label>
            <paper-dropdown class="dropdown" style="overflow:visible;">
                <core-menu selected="0" on-core-select="{{_setType}}" class="menu">
                    <paper-item label="sine"> <core-icon src="./icons/sine_.svg"></core-icon>Sine</paper-item>
                    <paper-item label="triangle"> <core-icon src="./icons/triangle_.svg"></core-icon>Triangle</paper-item>
                    <paper-item label="square"> <core-icon src="./icons/square_.svg"></core-icon> Square</paper-item>
                    <paper-item label="sawtooth"> <core-icon src="./icons/sawtooth_.svg"></core-icon> Sawtooth</paper-item>
                </core-menu>
            </paper-dropdown>
        </paper-dropdown-menu>
      </div>

        <paper-icon-button on-click="{{_toggleStart}}" id="start" src="icons/play.png" hidden></paper-icon-button>

        <div center horizontal layout>
          <core-tooltip label="Frequency in Hertz (cycles per second)">Freq</core-tooltip>
          <paper-slider pin="true" id="freqSlider" min="1" max="700" default="220" immediateValue="{{freqSliderValue}}" on-click="{{stopProp}}" on-immediate-value-change="{{setFreq}}" editable style="width:100%"></paper-slider>
        </div>

        <div center horizontal layout>
          <core-tooltip label="Detune in Cents (100 cents = 1 note)">Detune</core-tooltip>
          <paper-slider pin="true" id="detuneSlider" min="-1200" max="1200" default="0" step="100" immediateValue="{{detuneSliderValue}}" on-click="{{stopProp}}" on-immediate-value-change="{{setDetune}}" editable style="width:100%"></paper-slider>
        </div>

      </div> <!-- end olos-container-->
  </template>

  <script>
    (function(params){

      Polymer('olos-oscillator', {

        oscType: 'sine',

        // TO DO - make these work
        /**
         * Width of module
         * @property width
         * @type {Number}
         * @default 100
         */
        width: 100,
        /**
         * Height
         * @property height
         * @type {Number}
         * @default 100
         */
        height: 100,
        playing: false,

        // inputs and outputs
        output: null,
        frequencyParam: [],
        detuneParam: [],


        publicMethods: ['setupFreqSlider', 'setupOscillator'],

        rootfolder: '../olos-oscillator/',

        domReady: function() {
          var self = this;
          self._audioContext = audioContext;
          self.playing = false;

          // self.frequencyParam = audioContext.createGain();
          self.output = audioContext.createGain();
          self.freqSlider = this.$.freqSlider;
          self.freqSlider.value = 220;
          self.setupFreqSlider();
          self.start();
        },

        /**
         * Start oscillator
         */
        start: function(time) {
          var self = this;
          var t = time || self._audioContext.currentTime;
          this.$.start.src = self.rootfolder + "icons/stop.png";
          self._initOsc();
          self.oscillatorNode.start(t);
        },

        stop: function(time) {
          var self = this;
          var t = time || self._audioContext.currentTime;
          self.oscillatorNode.stop(t);
          this.$.start.src = self.rootfolder + "icons/play.png";
          self.oscillatorNode.disconnect();
          self.oscillatorNode = null;
        },

        _toggleStart: function() {
          if(!this.playing) {
            this.start();
          }
          else {
            this.stop();
          }
          this.playing = !this.playing;
        },

        setOutput: function(obj) {
          var self = this;
          self.oscillatorNode.connect(obj);
          self.output = obj;
        },

        _initOsc: function() {
          var self = this;
          if (!self.oscillatorNode) {
            var now = audioContext.currentTime;
            self.oscillatorNode = self._audioContext.createOscillator();
            self.oscillatorNode.type = this.oscType;
            self.oscillatorNode.frequency.setValueAtTime(self.freqSliderValue, now);

            if (this.modulator) {
              this.modulator.connect(this.oscillatorNode.frequency);
            }
            // if any connections are meant to go to this freqParam, connect them
            // for (var i = 0; i < window.olos._connections.length; i++) {
            //   var cnx = window.olos._connections[i];
            //   if (cnx.target.id === this.id && cnx.target.field === 'frequencyParam') {
            //     // cnx.source
            //     console.log('make connection');
            //     var src = cnx.source.element[cnx.source.field];
            //     // var src = cnx.source.element['oscillatorNode'];
            //     var dst = self.oscillatorNode.frequency;
            //     // var dst = self.output.gain;
            //     src.connect(dst);
            //     // cnx.source.element[cnx.source.field].connect(self.oscillatorNode.frequency);
            //     // window.olos.makeConnection(cnx.source.element, cnx.source.field, cnx.target.element, self.oscillatorNode);
            //   }
            // }
            // if (self.frequencyParam) {
            //   console.log(self.frequencyParam);
            //   self.frequencyParam.connect(self.oscillatorNode.frequency);
            // }
            // self.oscillatorNode.frequency.exponentialRampToValueAtTime(this.freq, now);

            if (self.output) {
              self.oscillatorNode.connect(self.output);
            }
          }
        },

        _setType: function(e, detail){
          if (detail.isSelected) {
            this.oscType = detail.item.innerText.toLowerCase();
            this.$.oscimage.src = this.rootfolder + 'icons/'+this.oscType+'_.svg';
            if (this.oscillatorNode){
              this.oscillatorNode.type = this.oscType;
            }
          }
        },

        setType: function(type) {
          this.oscType = type;
          this.oscillatorNode.type = this.oscType;

          // TO DO: also update the visual representation
          this.$.oscimage.src = this.rootfolder + '/icons/' + this.oscillatorNode.type + '_.svg';
        },

        setFreq: function(e, detail){
          var self = this;
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }

          if (self.freqSliderValue <=0 ) {
            return;
          }
          self.freq = self.freqSliderValue;

          self.freqChanged();
          if (self.oscillatorNode) {
            var now = audioContext.currentTime;
            if (typeof(self.freq) !== 'undefined' && self.freq > 0) {

              try {
                self.oscillatorNode.frequency.exponentialRampToValueAtTime(self.freq, now + 0.000001);
              } catch(e) {throw e}
            }
          }
        },

        setDetune: function(e, detail){
          var self = this;
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }

          self.detune = self.detuneSliderValue;

          // this.detuneChanged();
          if (self.oscillatorNode) {
            var now = audioContext.currentTime;
            self.oscillatorNode.detune.linearRampToValueAtTime(self.detune, now + 0.000001);
          }
        },

        stopProp: function(e) {
          e.preventDefault();
          e.stopPropagation();
        },

        // publicly editable
        setupFreqSlider: function() {
          this.freqSlider.min = 0.01;
          this.freqSlider.max = 500;
          this.freqSlider.step = .1;
          // this.freqSlider.value = 220;
        },

        setupOscillator: function() {
          this.oscillatorNode.type = 'sine';
          this.oscillatorNode.frequency.value = 220;
        },

        frequencyParamChanged: function() {
          if (this.frequencyParam[this.frequencyParam.length-1] instanceof AudioNode) {
            this.modulator = this.frequencyParam[this.frequencyParam.length-1];
            if (this.oscillatorNode) {
              this.modulator.connect(this.oscillatorNode.frequency)
            }
          }
          for (var i = 0; i < this.frequencyParam.length; i++) {
            if (this.frequencyParam[i] > 0) {
              this.freqSliderValue = olos.scaleStep(i); // + this.detune.value/12);
              this.setFreq();
            }
          }
        },

        detuneParamChanged: function() {
          console.log('detune param changed');
          if (this.detuneParam[this.detuneParam.length-1] instanceof AudioNode) {
            this.detuneModulator = this.detuneParam[this.detuneParam.length-1];
            if (this.oscillatorNode) {
              this.detuneModulator.connect(this.oscillatorNode.detune)
            }
          }
        },

        update: function() {
          this.frequencyParamChanged();
        },

        freqChanged: function() {
          if (this.freq <= 0) {
            this.freqSlider.value = 0.000000001;
            console.log('Error: Oscillator frequency must be greater than 0. Setting to 0.000001')
          }

          // this.freqSlider.value = this.freq;

        },

        // TO DO: animate!
        animate: function() {
          this.freqSliderValue = this.oscillatorNode.frequency.value;
          this.detuneSliderValue = this.oscillatorNode.detune.value;
        },

        dispose: function() {
          var nodes = ['output', 'oscillatorNode'];
          for (var i = 0; i < nodes.length; i++) {
            try {
              var node = self[nodes[i]];
              node.disconnect();
              node = null;
            } catch(e) { }
          }
        }

      });

    })();
  </script>
</polymer-element>
